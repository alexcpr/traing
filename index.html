<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pitaing vite le traing</title>
    <link rel="stylesheet" href="./assets/css/app.css">
</head>

<body>
    <div class="departures" id="departures-list">
        <table>
            <thead>
                <tr>
                    <th>Train</th>
                    <th>Destination</th>
                    <th>Départ</th>
                    <th>Part dans</th>
                    <th>Voie</th>
                </tr>
            </thead>
            <tbody id="departure-table-body">
            </tbody>
        </table>
    </div>

    <script>
        const apiKey = "46bb7fe8-44d8-482d-9cb5-eadba28a5209";
        const apiUrl = 'https://api.sncf.com/v1/coverage/sncf/stop_areas/stop_area:SNCF:87212027/departures';
        const tableBody = document.getElementById("departure-table-body");

        function formatCountdown(countdown) {
            const minutes = Math.floor(countdown / 60000);
            const seconds = Math.floor((countdown % 60000) / 1000);

            return `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
        }

        function calculateDelayInMinutes(realTime, baseTime) {
            const realTimeParts = realTime.split(':');
            const baseTimeParts = baseTime.split(':');

            const realHours = parseInt(realTimeParts[0], 10);
            const realMinutes = parseInt(realTimeParts[1], 10);

            const baseHours = parseInt(baseTimeParts[0], 10);
            const baseMinutes = parseInt(baseTimeParts[1], 10);

            const delayMinutes = (realHours - baseHours) * 60 + (realMinutes - baseMinutes);
            return delayMinutes;
        }

        function parseAndFormatDateTime(dateTimeString) {
            const year = parseInt(dateTimeString.slice(0, 4), 10);
            const month = parseInt(dateTimeString.slice(4, 6), 10) - 1;
            const day = parseInt(dateTimeString.slice(6, 8), 10);
            const hour = parseInt(dateTimeString.slice(9, 11), 10);
            const minute = parseInt(dateTimeString.slice(11, 13), 10);

            const date = new Date(year, month, day, hour, minute);
            return `${padZero(date.getHours())}:${padZero(date.getMinutes())}`;
        }


        function padZero(num) {
            return num.toString().padStart(2, '0');
        }

        function fetchTrainDepartures() {
            fetch(apiUrl, {
                method: "GET",
                headers: {
                    "Authorization": apiKey,
                }
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    displayDepartures(data.departures);
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        }

        function displayDepartures(departures) {
            departures.forEach(departure => {
                const row = tableBody.insertRow();
                const trainNameCell = row.insertCell(0);
                const destinationCell = row.insertCell(1);
                const realDepartureTimeCell = row.insertCell(2);
                const countdownCell = row.insertCell(3);
                const platformCell = row.insertCell(4);

                const displayInfo = departure.display_informations;
                const stopDateTime = departure.stop_date_time;

                const baseDepartureTime = parseAndFormatDateTime(stopDateTime.base_departure_date_time);

                platformCell.textContent = 'N/A';

                trainNameCell.textContent = `${displayInfo.network} - N° ${displayInfo.headsign}`;
                destinationCell.innerHTML = baseDepartureTime + " <strong>" + displayInfo.direction.split(' (')[0] + "</strong>";

                const realDepartureTime = parseAndFormatDateTime(stopDateTime.departure_date_time);

                if (realDepartureTime > baseDepartureTime) {
                    const delayMinutes = calculateDelayInMinutes(realDepartureTime, baseDepartureTime);
                    realDepartureTimeCell.textContent = realDepartureTime;
                    destinationCell.innerHTML = `<span class="delayed">${baseDepartureTime}</span> <strong>` + displayInfo.direction.split(' (')[0] + "</strong> (retardé de " + delayMinutes + " minutes)";
                } else {
                    realDepartureTimeCell.textContent = realDepartureTime;
                }

                const countdownInterval = setInterval(() => {
                    const now = new Date().getTime();
                    const departureTimeFormatted = stopDateTime.departure_date_time.replace(/(\d{4})(\d{2})(\d{2})T(\d{2})(\d{2})(\d{2})/, '$1-$2-$3T$4:$5:$6');
                    const departureTimeMillis = Date.parse(departureTimeFormatted);
                    const timeUntilDeparture = departureTimeMillis - now;

                    if (timeUntilDeparture > 0) {
                        countdownCell.textContent = formatCountdown(timeUntilDeparture - 1000);

                        if (timeUntilDeparture <= 0) {
                            clearInterval(countdownInterval);
                        }
                    } else {
                        countdownCell.textContent = "Le train est parti.";
                        clearInterval(countdownInterval);
                    }
                }, 1000);

                const trainId = departure.links[1].id;

                fetch(`https://api.sncf.com/v1/coverage/sncf/vehicle_journeys/${trainId}`, {
                    method: "GET",
                    headers: {
                        "Authorization": apiKey,
                    }
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! Status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        const stops = data.vehicle_journeys[0].stop_times.map(stop => stop.stop_point.name);
                        destinationCell.innerHTML += "<br>" + stops.join(" - ");
                    })
                    .catch(error => {
                        console.error('Error:', error);
                    });
            });
        }

        fetchTrainDepartures();

    </script>
</body>

</html>