<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pitaing vite le traing</title>
    <link rel="stylesheet" href="./assets/css/app.css?v=a28a5209eadc">
</head>

<body>
    <div class="main-container">
        <div class="station-selector" id="station-selector"></div>
        <div class="departures" id="departures-list">
            <table>
                <thead>
                    <tr>
                        <th>Train</th>
                        <th>Destination</th>
                        <th>Départ</th>
                        <th>Part dans</th>
                        <!-- <th>Voie</th> -->
                    </tr>
                </thead>
                <tbody id="departure-table-body">
                </tbody>
            </table>
        </div>
        <div class="more-departures">
            <input type="hidden" id="lastTrainDepartureInput" value="" />
            <button id="more-departures">⬇️ Plus tard</button>
        </div>
    </div>

    <script>
        const apiKey = "46bb7fe8-44d8-482d-9cb5-eadba28a5209";
        const tableBody = document.getElementById("departure-table-body");
        let apiUrl = "";

        function formatCountdown(countdown) {
            const minutes = Math.floor(countdown / 60000);
            const seconds = Math.floor((countdown % 60000) / 1000);

            return `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
        }

        function calculateDelayInMinutes(realTime, baseTime) {
            const realTimeParts = realTime.split(':');
            const baseTimeParts = baseTime.split(':');

            const realHours = parseInt(realTimeParts[0], 10);
            const realMinutes = parseInt(realTimeParts[1], 10);

            const baseHours = parseInt(baseTimeParts[0], 10);
            const baseMinutes = parseInt(baseTimeParts[1], 10);

            const delayMinutes = (realHours - baseHours) * 60 + (realMinutes - baseMinutes);
            return delayMinutes;
        }

        function parseAndFormatDateTime(dateTimeString) {
            const year = parseInt(dateTimeString.slice(0, 4), 10);
            const month = parseInt(dateTimeString.slice(4, 6), 10) - 1;
            const day = parseInt(dateTimeString.slice(6, 8), 10);
            const hour = parseInt(dateTimeString.slice(9, 11), 10);
            const minute = parseInt(dateTimeString.slice(11, 13), 10);

            const date = new Date(year, month, day, hour, minute);
            return `${padZero(date.getHours())}:${padZero(date.getMinutes())}`;
        }


        function padZero(num) {
            return num.toString().padStart(2, '0');
        }

        function fetchTrainDepartures(apiUrl) {
            while (tableBody.firstChild) {
                tableBody.removeChild(tableBody.firstChild);
            }
            fetch(apiUrl, {
                method: "GET",
                headers: {
                    "Authorization": apiKey,
                }
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    displayDepartures(data.departures);
                    const moreDeparturesButton = document.getElementById("more-departures");
                    moreDeparturesButton.style.display = data.departures.length > 0 ? "block" : "none";
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        }

        function displayDepartures(departures) {
            departures.forEach(departure => {
                const row = tableBody.insertRow();
                const trainNameCell = row.insertCell(0);
                const destinationCell = row.insertCell(1);
                const realDepartureTimeCell = row.insertCell(2);
                const countdownCell = row.insertCell(3);
                //const platformCell = row.insertCell(4);
                const displayInfo = departure.display_informations;
                const stopDateTime = departure.stop_date_time;
                const trainId = departure.links[1].id;
                const baseDepartureTime = parseAndFormatDateTime(stopDateTime.base_departure_date_time);
                const realDepartureTime = parseAndFormatDateTime(stopDateTime.departure_date_time);


                const viewStopsButton = document.createElement("button");
                viewStopsButton.textContent = "Voir les arrêts en gare";
                viewStopsButton.addEventListener("click", () => {
                    const trainId = hiddenInput.value;
                    fetchTrainStops(trainId, destinationCell);
                    viewStopsButton.remove();
                });

                const hiddenInput = document.createElement('input');
                hiddenInput.type = 'hidden';
                hiddenInput.value = trainId;

                //platformCell.textContent = 'N/A';

                countdownCell.textContent = "...";

                trainNameCell.textContent = `${displayInfo.network} - N° ${displayInfo.headsign}`;
                destinationCell.innerHTML = baseDepartureTime + " <strong>" + displayInfo.direction.split(' (')[0] + "</strong><br>";

                if (realDepartureTime > baseDepartureTime) {
                    const delayMinutes = calculateDelayInMinutes(realDepartureTime, baseDepartureTime);
                    realDepartureTimeCell.textContent = realDepartureTime;
                    destinationCell.innerHTML = `<span class="delayed">${baseDepartureTime}</span> <strong>` + displayInfo.direction.split(' (')[0] + "</strong> (retardé de " + delayMinutes + " minutes)<br>";
                } else {
                    realDepartureTimeCell.textContent = realDepartureTime;
                }

                const countdownInterval = setInterval(() => {
                    const now = new Date().getTime();
                    const departureTimeFormatted = stopDateTime.departure_date_time.replace(/(\d{4})(\d{2})(\d{2})T(\d{2})(\d{2})(\d{2})/, '$1-$2-$3T$4:$5:$6');
                    const departureTimeMillis = Date.parse(departureTimeFormatted);
                    const timeUntilDeparture = departureTimeMillis - now;

                    if (timeUntilDeparture > 0) {
                        countdownCell.textContent = formatCountdown(timeUntilDeparture - 1000);

                        if (timeUntilDeparture <= 0) {
                            clearInterval(countdownInterval);
                        }
                    } else {
                        countdownCell.textContent = "Le train est parti.";
                        clearInterval(countdownInterval);
                    }
                }, 1000);

                destinationCell.appendChild(viewStopsButton);
                destinationCell.appendChild(hiddenInput);

            });
            const lastTrainDeparture = departures[departures.length - 1].stop_date_time.departure_date_time;

            const hiddenInput = document.getElementById("lastTrainDepartureInput");
            if (hiddenInput) {
                hiddenInput.value = lastTrainDeparture;
            }

        }

        function fetchTrainStops(trainId, destinationCell) {
            fetch(`https://api.sncf.com/v1/coverage/sncf/vehicle_journeys/${trainId}`, {
                method: "GET",
                headers: {
                    "Authorization": apiKey,
                }
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    const stops = data.vehicle_journeys[0].stop_times.map(stop => stop.stop_point.name);
                    const stopsHTML = createStopsHTML(stops);
                    destinationCell.innerHTML += stopsHTML;
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        }

        function createStopsHTML(stops) {
            let stopsHTML = "<ul class=\"train-stops\">";
            stops.forEach(stop => {
                stopsHTML += `<li class="train-stop">${stop}</li>`;
            });
            stopsHTML += "</ul>";

            return stopsHTML;
        }


        const stationCodes = {
            "Strasbourg": "87212027",
            "Sélestat": "87214056",
            "Strasbourg-Roethig": "87212191",
        };

        const stationSelector = document.getElementById("station-selector");

        for (const stationName in stationCodes) {
            const button = document.createElement("button");
            button.textContent = stationName;
            button.addEventListener("click", () => {
                apiUrl = `https://api.sncf.com/v1/coverage/sncf/stop_areas/stop_area:SNCF:${stationCodes[stationName]}/departures`;
                fetchTrainDepartures(apiUrl);
            });
            stationSelector.appendChild(button);
        }

        const moreDeparturesButton = document.getElementById("more-departures");

        moreDeparturesButton.addEventListener("click", () => {
            const lastTrainDepartureTime = document.querySelector('.more-departures input[type="hidden"]').value;
            const apiUrlWithDatetime = `${apiUrl}?from_datetime=${lastTrainDepartureTime}`;
            fetchTrainDepartures(apiUrlWithDatetime);
        });


    </script>
</body>

</html>